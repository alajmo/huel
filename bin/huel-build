#!/usr/bin/env node

const defaultConfig = require('../config/huel.config.json');
const program = require('commander');
const tasks = require('../src/tasks/tasks.js');
const yaml = require('js-yaml');
const fs = require('fs');
const path = require('path');

program
  .option('--debug', `debug. [string] [default: ${defaultConfig.debug}]`)
  .option(
    '--env [env]',
    `environment. [string] [default: ${defaultConfig.env}]`
  )
  .option(
    '-t, --template <template>',
    `template for project. [string] [required] [default: ${
      defaultConfig.template
    }]`
  )
  .option(
    '-e, --entry <entry>',
    `entry for project. [string] [required] [default: ${defaultConfig.entry}]`
  )
  .option(
    '-o, --output <output>',
    `output for project. [string] [required] [default: ${defaultConfig.output}]`
  )
  .option(
    '-w, --watch',
    `start development server. [boolean] [default: ${defaultConfig.watch}]`
  )
  .option(
    '-p, --port [port]',
    `port webpack-dev-server listens on. [integer] [default: ${
      defaultConfig.port
    }]`
  )
  .on('--help', () => {
    console.log(`

  Examples:
    Production build
    $ huel build -t src/index.html -e src/app.js -o dist

    Start webpack-dev-server
    $ huel build -w -p 3001 -t src/index.html -e src/app.js -o dist
  `);
  })
  .parse(process.argv);

function getBuildOptions(options) {
  if (options.env !== undefined) {
    if (!['production', 'development'].includes(options.env)) {
      console.error(
        `error: option -e, --env requires either value 'production' or 'development'`
      );
      process.exit(1);
    }
  }

  let huelConfig = {};
  if (fs.existsSync(defaultConfig.configName)) {
    huelConfig = yaml.safeLoad(
      fs.readFileSync(defaultConfig.configName, 'utf8')
    );
  }

  if (!options.template && !huelConfig.template) {
    console.error('error: template is required');
    process.exit(1);
  }

  if (!options.entry && !huelConfig.entry) {
    console.error('error: entry is required');
    process.exit(1);
  }

  if (!options.output && !huelConfig.output) {
    console.error('error: output is required');
    process.exit(1);
  }

  return Object.freeze({
    debug: options.debug || defaultConfig.debug,
    entry: options.entry || huelConfig.entry || defaultConfig.entry,
    env: options.env || defaultConfig.env,
    output: options.output || huelConfig.output || defaultConfig.output,
    port: options.port || defaultConfig.port,
    template: options.template || huelConfig.template || defaultConfig.template,
    plugins: huelConfig.plugins,
    copyFiles: huelConfig.copyFiles,
    watch: options.watch || defaultConfig.watch
  });
}

main();
function main() {
  const opt = getBuildOptions(program);
  tasks.build(opt);
}
